
import os
import pathlib
import httpx

from dotenv import load_dotenv
from database.models.message import Message
from openai import OpenAI

OPENAI_API = None


load_dotenv()

""" HF_TOKEN = os.getenv("HF_TOKEN")

if HF_TOKEN is None:
    raise Exception("HF_TOKEN must be set")

model_name = "mistralai/Mistral-7B-Instruct-v0.2"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    cache_dir="./cache",
    dtype=torch.float16,
    device_map="auto",
    token=HF_TOKEN
) """

DOMAIN_INSTRUCTION = """Вы — виртуальный помощник официального сайта юридической компании. Отвечайте только по темам, связанным с предоставлением услуг компании: описание услуг, цены и скидки, срок выполнения, составление договоров, ведение дел в судах, банкротство, реорганизация, контакты офисов, рабочее время и прочая информация, содержащаяся в справочных данных (REFERENCE_DATA). 
Если пользователь задаёт вопрос, выходящий за рамки тематики сайта (медицина, финансовые советы, незаконные инструкции, персональные юридические консультации по конкретным делам, просьбы выступать в роли юриста для представительства без офлайн-контакта и т.п.), вежливо откажите и предложите связаться с офлайн-юристом или направить запрос через контактные данные. 
Формулируйте отказы коротко, корректно и без лишней информации."""
REFERENCE_DATA = """
{
  "company": {
    "name": "Юридическая Компания «Ваш Партнёр»",
    "tagline": "Профессионализм и надежность в решении ваших юридических вопросов",
    "description": "Наша юридическая компания специализируется на предоставлении полного спектра правовых услуг для бизнеса и частных клиентов. Мы оказываем поддержку в сложных правовых вопросах, консультируем и защищаем интересы наших клиентов на каждом этапе сотрудничества.",
    "mission": "Защищать права клиентов и обеспечивать юридическую безопасность бизнеса и частных лиц через квалифицированные, прозрачные и эффективные решения.",
    "working_principles": [
      "Индивидуальный подход",
      "Прозрачность и честность",
      "Профессиональная ответственность",
      "Соблюдение сроков и обязательств"
    ]
  },

  "catalog": [
    {
      "id": "liquidation",
      "label": "Ликвидация",
      "description": "Добровольная официальная ликвидация — единственный законный способ прекращения деятельности юридического лица. Компания может быть ликвидирована только после урегулирования вопросов с кредиторами и представления требуемой отчетности.",
      "price_rub": 40000,
      "sale": 0.05,
      "picture": "/img/store1.jpg",
      "worker_count": 4,
      "time_to_resolve": {"days": 7},
      "notes": "Стоимость указана ориентировочно; в отдельных случаях возможны дополнительные расходы (госпошлины, оплата аудитора и т.п.)."
    },
    {
      "id": "reorganization",
      "label": "Реорганизация",
      "description": "Реорганизация — процедура реформирования бизнеса с передачей прав и обязанностей правопреемнику: слияние, присоединение, выделение, разделение, преобразование и сочетание таких форм.",
      "price_rub": 35000,
      "sale": 0.04,
      "picture": "/img/reorganization.webp",
      "worker_count": 3,
      "time_to_resolve": {"days": 5},
      "notes": "Точный набор действий и сроки зависят от выбранной формы реорганизации и объёма документооборота."
    },
    {
      "id": "bankruptcy",
      "label": "Банкротство",
      "description": "Банкротство — это законный способ ликвидации предприятия с долгами. Процедура сложная и зависит от множества факторов: состава кредиторов, финансового состояния, возможных возражений контрагентов и т.д.",
      "price_rub": 50000,
      "sale": 0.10,
      "picture": "/img/default.jpg",
      "worker_count": 5,
      "time_to_resolve": {"days": 14},
      "notes": "Стоимость и сроки обсуждаются индивидуально после предварительного анализа документации и финансового состояния."
    },
    {
      "id": "court_representation",
      "label": "Ведение дел в судах",
      "description": "Представительство в суде на стороне истца, ответчика или третьего лица. Участие на всех стадиях процесса: подготовка исков/возражений, участие в заседаниях, апелляции и исполнение судебных решений.",
      "price_rub": 30000,
      "sale": 0.04,
      "picture": "/img/store2.jpg",
      "worker_count": 2,
      "time_to_resolve": {"days": 30},
      "notes": "Стоимость услуги может корректироваться в зависимости от стадии процесса и объёма подготовительных работ."
    },
    {
      "id": "legal_consultations",
      "label": "Юридические консультации",
      "description": "Оперативные устные и письменные консультации, составление правовых заключений, экспертное мнение адвоката.",
      "price_rub": 1000,
      "sale": 0.10,
      "picture": "/img/store5.jpg",
      "worker_count": 1,
      "time_to_resolve": {"hours": 1},
      "notes": "Стоимость указана за единичную консультацию; возможны пакеты услуг со скидкой."
    },
    {
      "id": "contract_drafting",
      "label": "Составление договоров",
      "description": "Разработка договоров и контрактов, подготовка правовой документации: заявления, жалобы, претензии и т.п.",
      "price_rub": 5000,
      "sale": 0.05,
      "picture": "/img/store6.webp",
      "worker_count": 1,
      "time_to_resolve": {"days": 1},
      "notes": "Точная цена зависит от сложности договора и необходимости дополнительной юридической экспертизы."
    }
  ],

  "commercial_cards": [
    {
      "right": {
        "label": "Поддержка бизнеса на всех этапах",
        "text": "Полное сопровождение бизнеса: регистрация, реорганизация, ликвидация, сопровождение сделок и корпоративных споров. Подготовка учредительных документов и оптимизация структуры управления.",
        "button_label": "В каталог",
        "picture_path": "/img/index-1.webp",
        "alt_picture": "index-1"
      },
      "left": {
        "label": "Защита прав работников и работодателей",
        "text": "Комплексная помощь в трудовых вопросах: разработка и адаптация трудовых договоров, консультации по трудовым гарантиям, представительство при трудовых спорах.",
        "button_label": "В каталог",
        "picture_path": "/img/index-2.webp",
        "alt_picture": "index-2"
      }
    },
    {
      "right": {
        "label": "Эффективное налоговое планирование",
        "text": "Консультации по налогообложению, выявление налоговых льгот и снижение налоговой нагрузки в рамках законодательства.",
        "button_label": "В каталог",
        "picture_path": "/img/index-3.webp",
        "alt_picture": "index-3"
      },
      "left": {
        "label": "Альтернативное разрешение споров",
        "text": "Медиация, переговоры и другие методы внесудебного разрешения споров с целью снижения затрат и сохранения деловых отношений.",
        "button_label": "В каталог",
        "picture_path": "/img/index-4.webp",
        "alt_picture": "index-4"
      }
    }
  ],

  "contacts": [
    {
      "id": "moscow_office",
      "title": "Офис в Москве",
      "address": "Москва, ул. Красная Пресня, д. 24, Бизнес-центр «Сибирь», 1-й вход, 3 этаж",
      "phones": ["8 (800) 555-83-25", "+7 (495) 966-15-56"],
      "working_time": "пн-пт: 10:00-19:00",
      "image": "/img/office1.jpg",
      "coordinates": [55.762277, 37.569899]
    },
    {
      "id": "spb_office",
      "title": "Офис в Санкт-Петербурге",
      "address": "Санкт-Петербург, ул. Большая Конюшенная, д. 29, Бизнес-центр «Эра-Хаус», 4 этаж",
      "phones": ["8 (800) 555-83-25", "+7 (812) 677-26-64"],
      "working_time": "пн-пт: 10:00-19:00",
      "image": "/img/office2.jpg",
      "coordinates": [59.936688, 30.322102]
    }
  ],

  "about_sections": [
    {
      "title": "Профессионализм и надежность",
      "text": "Наша юридическая компания специализируется на предоставлении полного спектра правовых услуг для бизнеса и частных клиентов. Мы оказываем поддержку в сложных правовых вопросах, консультируем и защищаем интересы наших клиентов на каждом этапе сотрудничества."
    },
    {
      "title": "Команда экспертов",
      "text": "В команде — опытные юристы и адвокаты, обладающие глубокими знаниями в различных отраслях права, от корпоративного и налогового до семейного и наследственного права. Мы верим в индивидуальный подход и стремимся найти лучшее решение для каждой ситуации."
    },
    {
      "title": "Наши ценности",
      "text": "Ответственность, честность и уважение к клиенту — принципы нашей работы. Открытое общение и соблюдение профессиональной этики — основа доверительных отношений."
    },
    {
      "title": "Комплексный подход",
      "text": "Мы разрабатываем стратегии и находим уникальные решения, отвечающие нуждам клиентов. Независимо от сложности вопроса, обеспечиваем внимательное и персонализированное обслуживание."
    },
    {
      "title": "Наши гарантии",
      "text": "Гарантируем профессионализм, четкость и ответственность в каждом действии. Работаем с полной вовлечённостью, соблюдая все обязательства перед клиентом."
    }
  ],

  "service_rules": {
    "allowed_topics": [
      "описание услуг",
      "цены и скидки по каталогам",
      "ориентировочные сроки исполнения",
      "адреса и телефоны офисов",
      "режим работы",
      "процедурные разъяснения (в общих чертах)",
      "инструкции по записи на консультацию и оплате услуг"
    ],
    "disallowed_topics": [
      "персональные юридические консультации по конкретному делу (требующие анализа документов)",
      "пошаговые инструкции для обхода закона или нарушения прав других лиц",
      "медицинские, финансовые и налоговые советы вне контекста общего информирования",
      "запросы на представительство без офлайн-договора и оплаты",
      "любые инструкции, которые могут представлять угрозу безопасности или нарушать закон"
    ],
    "offtopic_reply_short": "Извините, я могу ответить только на вопросы, связанные с услугами и информацией на сайте. По личным или сложным юридическим вопросам рекомендуем записаться на консультацию по телефону: +7 (495) 966-15-56.",
    "offtopic_reply_full": "Извините, я могу помочь только с информацией о наших услугах, ценах, сроках и контактах. Для персональной правовой помощи и разбора конкретных документов свяжитесь с нашими специалистами по телефону или через форму обратной связи на сайте. Мы не предоставляем полноценные персональные юридические консультации в чате."
  },

  "booking": {
    "phone_for_booking": "+7 (495) 966-15-56",
    "online_booking_url": "/contacts/booking",
    "required_for_booking": [
      "ФИО",
      "телефон",
      "короткое описание вопроса",
      "удобное время"
    ],
    "consultation_types": [
      {"type": "онлайн", "duration_minutes": 60},
      {"type": "офис", "duration_minutes": 60},
      {"type": "выезд", "duration_minutes": 120}
    ],
    "payment_methods": ["наличный расчет", "банковская карта", "безналичный перевод"]
  },

  "data_update_note": "REFERENCE_DATA хранит статическую справочную информацию сайта. При изменении каталога, контактов или цен — обновляйте этот объект и перезагружайте сервис. Не добавляйте в REFERENCE_DATA персональные данные клиентов."
}
"""

SYSTEM_PROMPT = DOMAIN_INSTRUCTION + "\n" + REFERENCE_DATA


OPENAI_API_KEY=os.getenv('OPENAI_API_KEY')
OPENAI_API_MODEL_NAME=os.getenv('OPENAI_API_MODEL_NAME')
OPENAI_BASE_URL=os.getenv('OPENAI_BASE_URL')

def load_openai_model():
    global OPENAI_API
    if OPENAI_API is not None:
        return
    OPENAI_API = OpenAI(
        base_url=OPENAI_BASE_URL,
        api_key=OPENAI_API_KEY
    )

def create_summary(user_prompt: str) -> str:
    if OPENAI_API is None:
        raise Exception("Model is not loaded")

    response = OPENAI_API.chat.completions.create(
        model=OPENAI_API_MODEL_NAME,
        messages=[
            {
                "role": "system",
                "content": SYSTEM_PROMPT
            },
            {
                "role": "user",
                "content": user_prompt
            }
        ]
    )

    return response.choices[0].message.content

async def get_answer(
    messages: list[Message],
    *,
    domain_instruction: str = DOMAIN_INSTRUCTION,
    reference_data: str = REFERENCE_DATA
) -> str:
    load_openai_model()
    dialogue = ""
    for m in messages:
        if m.from_user:
            dialogue += f"User: {m.text}\n"
        else:
            dialogue += f"Assistant: {m.text}\n"

    return create_summary(dialogue)
    

    
""" 
    print("log1")

    system_prompt = (
        f"System: {domain_instruction}\n"
        f"Исходные данные: {reference_data}\n\n"
    )
    print("log2")

    dialogue = ""
    for m in messages:
        if m.from_user:
            dialogue += f"User: {m.text}\n"
        else:
            dialogue += f"Assistant: {m.text}\n"
    dialogue += "Assistant:"

    full_prompt = system_prompt + dialogue

    inputs = tokenizer(full_prompt, return_tensors="pt").to(model.device)
    print("log3")

    def _generate():
        with torch.no_grad():
            output_ids = model.generate(
                **inputs,
                max_new_tokens=50,
                temperature=0.7,
                top_p=0.9,
                do_sample=True,
                
            )
        return output_ids

    output_ids = await asyncio.to_thread(_generate)

    print("log4")

    new_tokens = output_ids[0][inputs["input_ids"].shape[1]:]
    answer = tokenizer.decode(new_tokens, skip_special_tokens=True).strip()
    print(answer)
    return answer """
